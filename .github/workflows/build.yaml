name: Action

# Déclenche le workflow à chaque push sur la branche JulesAPI
on:
  push:
    branches:
      - JulesAPI

# Définition des jobs du workflow
jobs:
  build:
    # Spécifie l'environnement d'exécution
    runs-on: ubuntu-latest

    # Définition des services requis pour le job
    services:
      # Service Elasticsearch
      elasticsearch:
        image: docker.elastic.co/elasticsearch/elasticsearch:8.14.0
        ports:
          - 9200:9200

    steps:
      # Étape pour récupérer le code source du dépôt
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # Étape pour attendre que Elasticsearch soit prêt
      - name: Wait for Elasticsearch
        run: |
          until curl -sS http://127.0.0.1:9200; do
            echo "Waiting for Elasticsearch...";
            sleep 10;
          done

      # Étape pour copier le fichier des offres d'emploi dans le conteneur Elasticsearch
      - name: Copy Job Offers Data to Elasticsearch Container
        run: |
          docker cp data/all_prepared_jobs.json elasticsearch:/all_prepared_jobs.json

      # Étape pour indexer les données d'offres d'emploi dans Elasticsearch
      - name: Index Job Offers Data in Elasticsearch
        run: |
          docker exec elasticsearch curl -sS -H "Content-Type: application/json" -XPOST http://elasticsearch:9200/jobs_market/_bulk --data-binary @/all_prepared_jobs.json

      # Étape de Continuous Integration : Construire et pousser l'image Docker de l'application
      - name: Continuous Integration
        run: |
          docker build . -t ${{ secrets.DOCKER_USERNAME }}/job_market:latest
          docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}
          docker push ${{ secrets.DOCKER_USERNAME }}/job_market:latest

      # Étape de Continuous Deployment : Déployer l'application sur le serveur distant
      - name: Continuous Deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          port: ${{ secrets.PORT }}
          script: |
            # Créer un réseau Docker pour la communication entre conteneurs
            docker network create job_network || true

            # Arrêter et supprimer les conteneurs existants
            docker container stop job_market_api || true
            docker container rm job_market_api || true

            docker container stop elasticsearch || true
            docker container rm elasticsearch || true

            # Démarrer un nouveau conteneur Elasticsearch
            docker run -d --name elasticsearch --network job_network -p 9200:9200 docker.elastic.co/elasticsearch/elasticsearch:8.14.0

            # Attendre que Elasticsearch soit prêt
            until curl -sS http://127.0.0.1:9200; do
              echo "Waiting for Elasticsearch...";
              sleep 10;
            done

            # Copier le fichier des offres d'emploi dans le conteneur Elasticsearch
            docker cp data/job_offers.json elasticsearch:/job_offers.json

            # Indexer les données d'offres d'emploi dans Elasticsearch
            docker exec elasticsearch curl -sS -H "Content-Type: application/json" -XPOST http://elasticsearch:9200/offres_emploi4/_bulk --data-binary @/job_offers.json

            # Démarrer un nouveau conteneur pour l'application
            docker run -d --name job_market_api --network job_network -p 8000:8000 ${{ secrets.DOCKER_USERNAME }}/job_market:latest
